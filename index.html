<!DOCTYPE html>
<html lang="en">
 <head>
  <script type="importmap">
   {
  "imports": {
    "app": "data:text/javascript;base64,Y2xhc3MgVmlkZW9TZW5zb3JSZWNvcmRlciB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLm1lZGlhUmVjb3JkZXIgPSBudWxsOwogICAgICAgIHRoaXMuc3RyZWFtID0gbnVsbDsKICAgICAgICB0aGlzLnJlY29yZGVkQ2h1bmtzID0gW107CiAgICAgICAgdGhpcy5zZW5zb3JEYXRhID0gW107CiAgICAgICAgdGhpcy5pc1JlY29yZGluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuc3RhcnRUaW1lID0gbnVsbDsKICAgICAgICB0aGlzLnRpbWVySW50ZXJ2YWwgPSBudWxsOwogICAgICAgIHRoaXMuc2Vuc29yc0luaXRpYWxpemVkID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgdGhpcy5pbml0aWFsaXplRWxlbWVudHMoKTsKICAgICAgICB0aGlzLmJpbmRFdmVudHMoKTsKICAgICAgICB0aGlzLmluaXRpYWxpemVDYW1lcmEoKTsKICAgICAgICB0aGlzLmNoZWNrU2Vuc29yU3VwcG9ydCgpOwogICAgfQogICAgCiAgICBpbml0aWFsaXplRWxlbWVudHMoKSB7CiAgICAgICAgdGhpcy52aWRlb1ByZXZpZXcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmlkZW9QcmV2aWV3Jyk7CiAgICAgICAgdGhpcy5zdGFydEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGFydEJ0bicpOwogICAgICAgIHRoaXMuc3RvcEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdG9wQnRuJyk7CiAgICAgICAgdGhpcy5kb3dubG9hZEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkb3dubG9hZEJ0bicpOwogICAgICAgIHRoaXMuc3RhdHVzVGV4dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0dXNUZXh0Jyk7CiAgICAgICAgdGhpcy50aW1lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0aW1lcicpOwogICAgICAgIHRoaXMuYWNjZWxEYXRhID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjY2VsRGF0YScpOwogICAgICAgIHRoaXMuZ3lyb0RhdGEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ3lyb0RhdGEnKTsKICAgICAgICB0aGlzLnJlcXVlc3RQZXJtaXNzaW9uc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXF1ZXN0UGVybWlzc2lvbnMnKTsKICAgIH0KICAgIAogICAgYmluZEV2ZW50cygpIHsKICAgICAgICB0aGlzLnN0YXJ0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5zdGFydFJlY29yZGluZygpKTsKICAgICAgICB0aGlzLnN0b3BCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB0aGlzLnN0b3BSZWNvcmRpbmcoKSk7CiAgICAgICAgdGhpcy5kb3dubG9hZEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuZG93bmxvYWREYXRhKCkpOwogICAgICAgIHRoaXMucmVxdWVzdFBlcm1pc3Npb25zQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5yZXF1ZXN0UGVybWlzc2lvbnMoKSk7CiAgICB9CiAgICAKICAgIGNoZWNrU2Vuc29yU3VwcG9ydCgpIHsKICAgICAgICBpZiAoJ0RldmljZU1vdGlvbkV2ZW50JyBpbiB3aW5kb3cpIHsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ1NlbnNvcnMgc3VwcG9ydGVkIC0gQ2xpY2sgIlJlcXVlc3QgUGVybWlzc2lvbnMiJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnRGV2aWNlIHNlbnNvcnMgbm90IHN1cHBvcnRlZCc7CiAgICAgICAgICAgIHRoaXMucmVxdWVzdFBlcm1pc3Npb25zQnRuLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGFzeW5jIGluaXRpYWxpemVDYW1lcmEoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGhpcy5zdHJlYW0gPSBhd2FpdCBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSh7CiAgICAgICAgICAgICAgICB2aWRlbzogeyAKICAgICAgICAgICAgICAgICAgICBmYWNpbmdNb2RlOiAnZW52aXJvbm1lbnQnLAogICAgICAgICAgICAgICAgICAgIHdpZHRoOiB7IGlkZWFsOiAxMjgwIH0sCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiB7IGlkZWFsOiA3MjAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGF1ZGlvOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnZpZGVvUHJldmlldy5zcmNPYmplY3QgPSB0aGlzLnN0cmVhbTsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0NhbWVyYSByZWFkeSAtIFJlcXVlc3Qgc2Vuc29yIHBlcm1pc3Npb25zJzsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBhY2Nlc3NpbmcgY2FtZXJhOicsIGVycm9yKTsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0NhbWVyYSBhY2Nlc3MgZGVuaWVkJzsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGFzeW5jIHJlcXVlc3RQZXJtaXNzaW9ucygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnUmVxdWVzdGluZyBzZW5zb3IgcGVybWlzc2lvbnMuLi4nOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgb24gaU9TIDEzKyB0aGF0IHJlcXVpcmVzIHBlcm1pc3Npb24KICAgICAgICAgICAgaWYgKHR5cGVvZiBEZXZpY2VNb3Rpb25FdmVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIERldmljZU1vdGlvbkV2ZW50LnJlcXVlc3RQZXJtaXNzaW9uID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnUmVxdWVzdGluZyBpT1MgRGV2aWNlTW90aW9uIHBlcm1pc3Npb24uLi4nKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1vdGlvblBlcm1pc3Npb24gPSBhd2FpdCBEZXZpY2VNb3Rpb25FdmVudC5yZXF1ZXN0UGVybWlzc2lvbigpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ01vdGlvbiBwZXJtaXNzaW9uIHJlc3VsdDonLCBtb3Rpb25QZXJtaXNzaW9uKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKG1vdGlvblBlcm1pc3Npb24gPT09ICdncmFudGVkJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZW5zb3JMaXN0ZW5pbmcoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnU2Vuc29yIHBlcm1pc3Npb25zIGdyYW50ZWQnOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFBlcm1pc3Npb25zQnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdTZW5zb3IgcGVybWlzc2lvbnMgZGVuaWVkJzsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBGb3Igbm9uLWlPUyBkZXZpY2VzIG9yIG9sZGVyIGlPUyB2ZXJzaW9ucwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ05vIHBlcm1pc3Npb24gcmVxdWlyZWQsIHN0YXJ0aW5nIHNlbnNvcnMuLi4nKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZW5zb3JMaXN0ZW5pbmcoKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdTZW5zb3JzIGluaXRpYWxpemVkJzsKICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFBlcm1pc3Npb25zQnRuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFsc28gdHJ5IERldmljZU9yaWVudGF0aW9uRXZlbnQgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgIGlmICh0eXBlb2YgRGV2aWNlT3JpZW50YXRpb25FdmVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIERldmljZU9yaWVudGF0aW9uRXZlbnQucmVxdWVzdFBlcm1pc3Npb24gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9yaWVudGF0aW9uUGVybWlzc2lvbiA9IGF3YWl0IERldmljZU9yaWVudGF0aW9uRXZlbnQucmVxdWVzdFBlcm1pc3Npb24oKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdPcmllbnRhdGlvbiBwZXJtaXNzaW9uIHJlc3VsdDonLCBvcmllbnRhdGlvblBlcm1pc3Npb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHJlcXVlc3RpbmcgcGVybWlzc2lvbnM6JywgZXJyb3IpOwogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnRXJyb3IgcmVxdWVzdGluZyBwZXJtaXNzaW9uczogJyArIGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfQogICAgfQogICAgCiAgICBzdGFydFNlbnNvckxpc3RlbmluZygpIHsKICAgICAgICBjb25zb2xlLmxvZygnU3RhcnRpbmcgc2Vuc29yIGxpc3RlbmVycy4uLicpOwogICAgICAgIAogICAgICAgIC8vIExpc3RlbiBmb3IgZGV2aWNlIG1vdGlvbiBldmVudHMgKGFjY2VsZXJvbWV0ZXIgKyBneXJvc2NvcGUpCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2RldmljZW1vdGlvbicsIChldmVudCkgPT4gewogICAgICAgICAgICBjb25zb2xlLmxvZygnRGV2aWNlTW90aW9uIGV2ZW50IHJlY2VpdmVkOicsIGV2ZW50KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChldmVudC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5KSB7CiAgICAgICAgICAgICAgICBjb25zdCBhY2NlbCA9IGV2ZW50LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHk7CiAgICAgICAgICAgICAgICB0aGlzLmFjY2VsRGF0YS50ZXh0Q29udGVudCA9IGB4OiAkeyhhY2NlbC54IHx8IDApLnRvRml4ZWQoMil9LCB5OiAkeyhhY2NlbC55IHx8IDApLnRvRml4ZWQoMil9LCB6OiAkeyhhY2NlbC56IHx8IDApLnRvRml4ZWQoMil9YDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGV2ZW50LnJvdGF0aW9uUmF0ZSkgewogICAgICAgICAgICAgICAgY29uc3QgZ3lybyA9IGV2ZW50LnJvdGF0aW9uUmF0ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ3lyb0RhdGEudGV4dENvbnRlbnQgPSBgzrE6ICR7KGd5cm8uYWxwaGEgfHwgMCkudG9GaXhlZCgyKX0sIM6yOiAkeyhneXJvLmJldGEgfHwgMCkudG9GaXhlZCgyKX0sIM6zOiAkeyhneXJvLmdhbW1hIHx8IDApLnRvRml4ZWQoMil9YDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVjb3JkIHNlbnNvciBkYXRhIGlmIHJlY29yZGluZwogICAgICAgICAgICBpZiAodGhpcy5pc1JlY29yZGluZykgewogICAgICAgICAgICAgICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lOwogICAgICAgICAgICAgICAgdGhpcy5zZW5zb3JEYXRhLnB1c2goewogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBhY2NlbGVyb21ldGVyOiBldmVudC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5ID8gewogICAgICAgICAgICAgICAgICAgICAgICB4OiBldmVudC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5LnggfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgeTogZXZlbnQuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eS55IHx8IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHo6IGV2ZW50LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHkueiB8fCAwCiAgICAgICAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgZ3lyb3Njb3BlOiBldmVudC5yb3RhdGlvblJhdGUgPyB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhOiBldmVudC5yb3RhdGlvblJhdGUuYWxwaGEgfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgYmV0YTogZXZlbnQucm90YXRpb25SYXRlLmJldGEgfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgZ2FtbWE6IGV2ZW50LnJvdGF0aW9uUmF0ZS5nYW1tYSB8fCAwCiAgICAgICAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWw6IGV2ZW50LmludGVydmFsIHx8IDAKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwgeyBwYXNzaXZlOiB0cnVlIH0pOwogICAgICAgIAogICAgICAgIC8vIEFsc28gbGlzdGVuIGZvciBkZXZpY2Ugb3JpZW50YXRpb24gZXZlbnRzIGFzIGJhY2t1cAogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2VvcmllbnRhdGlvbicsIChldmVudCkgPT4gewogICAgICAgICAgICBjb25zb2xlLmxvZygnRGV2aWNlT3JpZW50YXRpb24gZXZlbnQgcmVjZWl2ZWQ6JywgZXZlbnQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSBneXJvIGRhdGEgZnJvbSBkZXZpY2Vtb3Rpb24sIHVzZSBvcmllbnRhdGlvbgogICAgICAgICAgICBpZiAoIXRoaXMuZ3lyb0RhdGEudGV4dENvbnRlbnQuaW5jbHVkZXMoJ86xOicpIHx8IHRoaXMuZ3lyb0RhdGEudGV4dENvbnRlbnQuaW5jbHVkZXMoJzAuMDAnKSkgewogICAgICAgICAgICAgICAgdGhpcy5neXJvRGF0YS50ZXh0Q29udGVudCA9IGDOsTogJHsoZXZlbnQuYWxwaGEgfHwgMCkudG9GaXhlZCgyKX0sIM6yOiAkeyhldmVudC5iZXRhIHx8IDApLnRvRml4ZWQoMil9LCDOszogJHsoZXZlbnQuZ2FtbWEgfHwgMCkudG9GaXhlZCgyKX1gOwogICAgICAgICAgICB9CiAgICAgICAgfSwgeyBwYXNzaXZlOiB0cnVlIH0pOwogICAgICAgIAogICAgICAgIHRoaXMuc2Vuc29yc0luaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAKICAgICAgICAvLyBUZXN0IGlmIHNlbnNvcnMgYXJlIGFjdHVhbGx5IHdvcmtpbmcgYWZ0ZXIgYSBzaG9ydCBkZWxheQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAodGhpcy5hY2NlbERhdGEudGV4dENvbnRlbnQuaW5jbHVkZXMoJ3g6IDAsIHk6IDAsIHo6IDAnKSkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ1NlbnNvcnMgbWF5IG5vdCBiZSB3b3JraW5nIC0gdHJ5IG1vdmluZyBkZXZpY2UnOwogICAgICAgICAgICB9CiAgICAgICAgfSwgMjAwMCk7CiAgICB9CiAgICAKICAgIGFzeW5jIHN0YXJ0UmVjb3JkaW5nKCkgewogICAgICAgIGlmICghdGhpcy5zdHJlYW0pIHsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0NhbWVyYSBub3QgYXZhaWxhYmxlJzsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoIXRoaXMuc2Vuc29yc0luaXRpYWxpemVkKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdQbGVhc2UgcmVxdWVzdCBzZW5zb3IgcGVybWlzc2lvbnMgZmlyc3QnOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzIGRhdGEKICAgICAgICAgICAgdGhpcy5yZWNvcmRlZENodW5rcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNlbnNvckRhdGEgPSBbXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldHVwIG1lZGlhIHJlY29yZGVyIHdpdGggYmV0dGVyIGlPUyBjb21wYXRpYmlsaXR5CiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7IG1pbWVUeXBlOiAndmlkZW8vbXA0JyB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJ5IGRpZmZlcmVudCBjb2RlY3MgZm9yIGJldHRlciBpT1MgY29tcGF0aWJpbGl0eQogICAgICAgICAgICBpZiAoTWVkaWFSZWNvcmRlci5pc1R5cGVTdXBwb3J0ZWQoJ3ZpZGVvL21wNDsgY29kZWNzPWF2YzEuNDJFMDFFLG1wNGEuNDAuMicpKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLm1pbWVUeXBlID0gJ3ZpZGVvL21wNDsgY29kZWNzPWF2YzEuNDJFMDFFLG1wNGEuNDAuMic7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoTWVkaWFSZWNvcmRlci5pc1R5cGVTdXBwb3J0ZWQoJ3ZpZGVvL3dlYm07IGNvZGVjcz12cDgsb3B1cycpKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLm1pbWVUeXBlID0gJ3ZpZGVvL3dlYm07IGNvZGVjcz12cDgsb3B1cyc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoTWVkaWFSZWNvcmRlci5pc1R5cGVTdXBwb3J0ZWQoJ3ZpZGVvL3dlYm0nKSkgewogICAgICAgICAgICAgICAgb3B0aW9ucy5taW1lVHlwZSA9ICd2aWRlby93ZWJtJzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coJ1VzaW5nIE1JTUUgdHlwZTonLCBvcHRpb25zLm1pbWVUeXBlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVkaWFSZWNvcmRlciA9IG5ldyBNZWRpYVJlY29yZGVyKHRoaXMuc3RyZWFtLCBvcHRpb25zKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVkaWFSZWNvcmRlci5vbmRhdGFhdmFpbGFibGUgPSAoZXZlbnQpID0+IHsKICAgICAgICAgICAgICAgIGlmIChldmVudC5kYXRhLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRlZENodW5rcy5wdXNoKGV2ZW50LmRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZWRpYVJlY29yZGVyLm9uc3RvcCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuZG93bmxvYWRCdG4uZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVkaWFSZWNvcmRlci5vbmVycm9yID0gKGV2ZW50KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdNZWRpYVJlY29yZGVyIGVycm9yOicsIGV2ZW50KTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdSZWNvcmRpbmcgZXJyb3Igb2NjdXJyZWQnOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhcnQgcmVjb3JkaW5nCiAgICAgICAgICAgIHRoaXMubWVkaWFSZWNvcmRlci5zdGFydCgxMDApOyAvLyBSZWNvcmQgaW4gMTAwbXMgY2h1bmtzCiAgICAgICAgICAgIHRoaXMuaXNSZWNvcmRpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IERhdGUubm93KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgdGhpcy5zdGFydEJ0bi5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuc3RvcEJ0bi5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRvd25sb2FkQnRuLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ1JlY29yZGluZy4uLic7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCB0aW1lcgogICAgICAgICAgICB0aGlzLnN0YXJ0VGltZXIoKTsKICAgICAgICAgICAgCiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igc3RhcnRpbmcgcmVjb3JkaW5nOicsIGVycm9yKTsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0Vycm9yIHN0YXJ0aW5nIHJlY29yZGluZzogJyArIGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfQogICAgfQogICAgCiAgICBzdG9wUmVjb3JkaW5nKCkgewogICAgICAgIGlmICh0aGlzLm1lZGlhUmVjb3JkZXIgJiYgdGhpcy5pc1JlY29yZGluZykgewogICAgICAgICAgICB0aGlzLm1lZGlhUmVjb3JkZXIuc3RvcCgpOwogICAgICAgICAgICB0aGlzLmlzUmVjb3JkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAgICAgdGhpcy5zdGFydEJ0bi5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnN0b3BCdG4uZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBgUmVjb3JkaW5nIHN0b3BwZWQgLSAke3RoaXMuc2Vuc29yRGF0YS5sZW5ndGh9IHNlbnNvciBzYW1wbGVzIGNvbGxlY3RlZGA7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9wIHRpbWVyCiAgICAgICAgICAgIHRoaXMuc3RvcFRpbWVyKCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICBzdGFydFRpbWVyKCkgewogICAgICAgIHRoaXMudGltZXJJbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhcnRUaW1lKSB7CiAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkID0gRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lOwogICAgICAgICAgICAgICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IoZWxhcHNlZCAvIDYwMDAwKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKChlbGFwc2VkICUgNjAwMDApIC8gMTAwMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRpbWVyLnRleHRDb250ZW50ID0gYCR7bWludXRlcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7c2Vjb25kcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDsKICAgICAgICAgICAgfQogICAgICAgIH0sIDEwMDApOwogICAgfQogICAgCiAgICBzdG9wVGltZXIoKSB7CiAgICAgICAgaWYgKHRoaXMudGltZXJJbnRlcnZhbCkgewogICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMudGltZXJJbnRlcnZhbCk7CiAgICAgICAgICAgIHRoaXMudGltZXJJbnRlcnZhbCA9IG51bGw7CiAgICAgICAgfQogICAgfQogICAgCiAgICBkb3dubG9hZERhdGEoKSB7CiAgICAgICAgaWYgKHRoaXMucmVjb3JkZWRDaHVua3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdObyByZWNvcmRpbmcgdG8gZG93bmxvYWQnOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIENyZWF0ZSB2aWRlbyBibG9iCiAgICAgICAgY29uc3QgdmlkZW9CbG9iID0gbmV3IEJsb2IodGhpcy5yZWNvcmRlZENodW5rcywgeyB0eXBlOiAndmlkZW8vbXA0JyB9KTsKICAgICAgICAKICAgICAgICAvLyBDcmVhdGUgc2Vuc29yIGRhdGEgSlNPTiB3aXRoIG1ldGFkYXRhCiAgICAgICAgY29uc3QgZGF0YVBhY2thZ2UgPSB7CiAgICAgICAgICAgIG1ldGFkYXRhOiB7CiAgICAgICAgICAgICAgICByZWNvcmRpbmdTdGFydDogbmV3IERhdGUodGhpcy5zdGFydFRpbWUpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lLAogICAgICAgICAgICAgICAgc2FtcGxlQ291bnQ6IHRoaXMuc2Vuc29yRGF0YS5sZW5ndGgsCiAgICAgICAgICAgICAgICB1c2VyQWdlbnQ6IG5hdmlnYXRvci51c2VyQWdlbnQKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2Vuc29yRGF0YTogdGhpcy5zZW5zb3JEYXRhCiAgICAgICAgfTsKICAgICAgICAKICAgICAgICBjb25zdCBzZW5zb3JCbG9iID0gbmV3IEJsb2IoW0pTT04uc3RyaW5naWZ5KGRhdGFQYWNrYWdlLCBudWxsLCAyKV0sIHsgCiAgICAgICAgICAgIHR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyAKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICAvLyBDcmVhdGUgY29tYmluZWQgZGF0YSBwYWNrYWdlCiAgICAgICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnJlcGxhY2UoL1s6Ll0vZywgJy0nKTsKICAgICAgICAKICAgICAgICAvLyBEb3dubG9hZCB2aWRlbwogICAgICAgIGNvbnN0IHZpZGVvVXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTCh2aWRlb0Jsb2IpOwogICAgICAgIGNvbnN0IHZpZGVvTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICB2aWRlb0xpbmsuaHJlZiA9IHZpZGVvVXJsOwogICAgICAgIHZpZGVvTGluay5kb3dubG9hZCA9IGByZWNvcmRpbmdfJHt0aW1lc3RhbXB9Lm1wNGA7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh2aWRlb0xpbmspOwogICAgICAgIHZpZGVvTGluay5jbGljaygpOwogICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodmlkZW9MaW5rKTsKICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHZpZGVvVXJsKTsKICAgICAgICAKICAgICAgICAvLyBEb3dubG9hZCBzZW5zb3IgZGF0YQogICAgICAgIGNvbnN0IHNlbnNvclVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc2Vuc29yQmxvYik7CiAgICAgICAgY29uc3Qgc2Vuc29yTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICBzZW5zb3JMaW5rLmhyZWYgPSBzZW5zb3JVcmw7CiAgICAgICAgc2Vuc29yTGluay5kb3dubG9hZCA9IGBzZW5zb3JfZGF0YV8ke3RpbWVzdGFtcH0uanNvbmA7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzZW5zb3JMaW5rKTsKICAgICAgICBzZW5zb3JMaW5rLmNsaWNrKCk7CiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzZW5zb3JMaW5rKTsKICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHNlbnNvclVybCk7CiAgICAgICAgCiAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0ZpbGVzIGRvd25sb2FkZWQgc3VjY2Vzc2Z1bGx5JzsKICAgIH0KfQoKLy8gSW5pdGlhbGl6ZSB0aGUgYXBwIHdoZW4gdGhlIHBhZ2UgbG9hZHMKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpID0+IHsKICAgIG5ldyBWaWRlb1NlbnNvclJlY29yZGVyKCk7Cn0pOwoKLy8gSGFuZGxlIHBhZ2UgdmlzaWJpbGl0eSBjaGFuZ2VzIChpbXBvcnRhbnQgZm9yIGlPUykKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScsICgpID0+IHsKICAgIGlmIChkb2N1bWVudC5oaWRkZW4pIHsKICAgICAgICBjb25zb2xlLmxvZygnUGFnZSBoaWRkZW4nKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coJ1BhZ2UgdmlzaWJsZScpOwogICAgfQp9KTsKCi8vIEFkZCBzb21lIGRlYnVnZ2luZyBmb3IgaU9TCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4gewogICAgY29uc29sZS5sb2coJ1BhZ2UgbG9hZGVkJyk7CiAgICBjb25zb2xlLmxvZygnRGV2aWNlTW90aW9uRXZlbnQgYXZhaWxhYmxlOicsIHR5cGVvZiBEZXZpY2VNb3Rpb25FdmVudCAhPT0gJ3VuZGVmaW5lZCcpOwogICAgY29uc29sZS5sb2coJ0RldmljZU1vdGlvbkV2ZW50LnJlcXVlc3RQZXJtaXNzaW9uIGF2YWlsYWJsZTonLCB0eXBlb2YgRGV2aWNlTW90aW9uRXZlbnQgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBEZXZpY2VNb3Rpb25FdmVudC5yZXF1ZXN0UGVybWlzc2lvbiA9PT0gJ2Z1bmN0aW9uJyk7CiAgICBjb25zb2xlLmxvZygnVXNlciBhZ2VudDonLCBuYXZpZ2F0b3IudXNlckFnZW50KTsKfSk7Cg=="
  }
}
  </script>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Video + Sensor Recorder
  </title>
  <link href="data:text/css;base64,KiB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKfQoKYm9keSB7CiAgICBmb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAnU2Vnb2UgVUknLCBSb2JvdG8sIHNhbnMtc2VyaWY7CiAgICBiYWNrZ3JvdW5kOiAjZjVmNWY1OwogICAgcGFkZGluZzogMjBweDsKfQoKLmNvbnRhaW5lciB7CiAgICBtYXgtd2lkdGg6IDYwMHB4OwogICAgbWFyZ2luOiAwIGF1dG87CiAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICBwYWRkaW5nOiAyMHB4OwogICAgYm94LXNoYWRvdzogMCAycHggMTBweCByZ2JhKDAsMCwwLDAuMSk7Cn0KCmgxIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGNvbG9yOiAjMzMzOwogICAgbWFyZ2luLWJvdHRvbTogMjBweDsKfQoKLnZpZGVvLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTAwJTsKICAgIG1heC13aWR0aDogNDAwcHg7CiAgICBtYXJnaW46IDAgYXV0byAyMHB4OwogICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJhY2tncm91bmQ6ICMwMDA7Cn0KCiN2aWRlb1ByZXZpZXcgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IGF1dG87CiAgICBkaXNwbGF5OiBibG9jazsKfQoKLmNvbnRyb2xzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDEwcHg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDIwcHg7CiAgICBmbGV4LXdyYXA6IHdyYXA7Cn0KCi5idG4gewogICAgcGFkZGluZzogMTJweCAyNHB4OwogICAgYm9yZGVyOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgZm9udC1zaXplOiAxNnB4OwogICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgbWluLXdpZHRoOiAxMjBweDsKfQoKLmJ0bi1zdGFydCB7CiAgICBiYWNrZ3JvdW5kOiAjNENBRjUwOwogICAgY29sb3I6IHdoaXRlOwp9CgouYnRuLXN0YXJ0OmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgIGJhY2tncm91bmQ6ICM0NWEwNDk7Cn0KCi5idG4tc3RvcCB7CiAgICBiYWNrZ3JvdW5kOiAjZjQ0MzM2OwogICAgY29sb3I6IHdoaXRlOwp9CgouYnRuLXN0b3A6aG92ZXI6bm90KDpkaXNhYmxlZCkgewogICAgYmFja2dyb3VuZDogI2RhMTkwYjsKfQoKLmJ0bi1kb3dubG9hZCB7CiAgICBiYWNrZ3JvdW5kOiAjMjE5NkYzOwogICAgY29sb3I6IHdoaXRlOwp9CgouYnRuLWRvd25sb2FkOmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgIGJhY2tncm91bmQ6ICMwYjdkZGE7Cn0KCi5idG4tc2Vjb25kYXJ5IHsKICAgIGJhY2tncm91bmQ6ICNmZjk4MDA7CiAgICBjb2xvcjogd2hpdGU7Cn0KCi5idG4tc2Vjb25kYXJ5OmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgIGJhY2tncm91bmQ6ICNlNjg5MDA7Cn0KCi5idG46ZGlzYWJsZWQgewogICAgb3BhY2l0eTogMC41OwogICAgY3Vyc29yOiBub3QtYWxsb3dlZDsKfQoKLnN0YXR1cyB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiAyMHB4Owp9Cgojc3RhdHVzVGV4dCB7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBjb2xvcjogIzY2NjsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQoKI3RpbWVyIHsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6ICMzMzM7CiAgICBmb250LWZhbWlseTogJ0NvdXJpZXIgTmV3JywgbW9ub3NwYWNlOwp9Cgouc2Vuc29yLWRhdGEgewogICAgYmFja2dyb3VuZDogI2Y4ZjlmYTsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICBtYXJnaW4tYm90dG9tOiAyMHB4Owp9Cgouc2Vuc29yLWRhdGEgaDMgewogICAgbWFyZ2luLWJvdHRvbTogMTBweDsKICAgIGNvbG9yOiAjMzMzOwp9Cgouc2Vuc29yLXJvdyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTRweDsKfQoKLnNlbnNvci1yb3cgc3BhbjpmaXJzdC1jaGlsZCB7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjNTU1Owp9CgoucGVybWlzc2lvbnMgewogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgpAbWVkaWEgKG1heC13aWR0aDogNDgwcHgpIHsKICAgIC5jb250YWluZXIgewogICAgICAgIHBhZGRpbmc6IDE1cHg7CiAgICB9CiAgICAKICAgIC5jb250cm9scyB7CiAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgfQogICAgCiAgICAuYnRuIHsKICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICBtYXgtd2lkdGg6IDIwMHB4OwogICAgfQp9Cg==" rel="stylesheet"/>
 </head>
 <body>
  <div class="container">
   <h1>
    Video + Sensor Recorder
   </h1>
   <div class="video-container">
    <video autoplay="" id="videoPreview" muted="" playsinline="">
    </video>
   </div>
   <div class="controls">
    <button class="btn btn-start" id="startBtn">
     Start Recording
    </button>
    <button class="btn btn-stop" disabled="" id="stopBtn">
     Stop Recording
    </button>
    <button class="btn btn-download" disabled="" id="downloadBtn">
     Download Data
    </button>
   </div>
   <div class="status">
    <div id="statusText">
     Ready to record
    </div>
    <div id="timer">
     00:00
    </div>
   </div>
   <div class="sensor-data">
    <h3>
     Live Sensor Data
    </h3>
    <div class="sensor-row">
     <span>
      Accelerometer:
     </span>
     <span id="accelData">
      x: 0, y: 0, z: 0
     </span>
    </div>
    <div class="sensor-row">
     <span>
      Gyroscope:
     </span>
     <span id="gyroData">
      x: 0, y: 0, z: 0
     </span>
    </div>
   </div>
   <div class="permissions">
    <button class="btn btn-secondary" id="requestPermissions">
     Request Permissions
    </button>
   </div>
  </div>
  <script>
   class VideoSensorRecorder {
    constructor() {
        this.mediaRecorder = null;
        this.stream = null;
        this.recordedChunks = [];
        this.sensorData = [];
        this.isRecording = false;
        this.startTime = null;
        this.timerInterval = null;
        this.sensorsInitialized = false;
        
        this.initializeElements();
        this.bindEvents();
        this.initializeCamera();
        this.checkSensorSupport();
    }
    
    initializeElements() {
        this.videoPreview = document.getElementById('videoPreview');
        this.startBtn = document.getElementById('startBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.statusText = document.getElementById('statusText');
        this.timer = document.getElementById('timer');
        this.accelData = document.getElementById('accelData');
        this.gyroData = document.getElementById('gyroData');
        this.requestPermissionsBtn = document.getElementById('requestPermissions');
    }
    
    bindEvents() {
        this.startBtn.addEventListener('click', () => this.startRecording());
        this.stopBtn.addEventListener('click', () => this.stopRecording());
        this.downloadBtn.addEventListener('click', () => this.downloadData());
        this.requestPermissionsBtn.addEventListener('click', () => this.requestPermissions());
    }
    
    checkSensorSupport() {
        if ('DeviceMotionEvent' in window) {
            this.statusText.textContent = 'Sensors supported - Click "Request Permissions"';
        } else {
            this.statusText.textContent = 'Device sensors not supported';
            this.requestPermissionsBtn.disabled = true;
        }
    }
    
    async initializeCamera() {
        try {
            this.stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: true
            });
            this.videoPreview.srcObject = this.stream;
            this.statusText.textContent = 'Camera ready - Request sensor permissions';
        } catch (error) {
            console.error('Error accessing camera:', error);
            this.statusText.textContent = 'Camera access denied';
        }
    }
    
    async requestPermissions() {
        try {
            this.statusText.textContent = 'Requesting sensor permissions...';
            
            // Check if we're on iOS 13+ that requires permission
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                console.log('Requesting iOS DeviceMotion permission...');
                const motionPermission = await DeviceMotionEvent.requestPermission();
                console.log('Motion permission result:', motionPermission);
                
                if (motionPermission === 'granted') {
                    this.startSensorListening();
                    this.statusText.textContent = 'Sensor permissions granted';
                    this.requestPermissionsBtn.style.display = 'none';
                } else {
                    this.statusText.textContent = 'Sensor permissions denied';
                    return;
                }
            } else {
                // For non-iOS devices or older iOS versions
                console.log('No permission required, starting sensors...');
                this.startSensorListening();
                this.statusText.textContent = 'Sensors initialized';
                this.requestPermissionsBtn.style.display = 'none';
            }
            
            // Also try DeviceOrientationEvent if available
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                const orientationPermission = await DeviceOrientationEvent.requestPermission();
                console.log('Orientation permission result:', orientationPermission);
            }
            
        } catch (error) {
            console.error('Error requesting permissions:', error);
            this.statusText.textContent = 'Error requesting permissions: ' + error.message;
        }
    }
    
    startSensorListening() {
        console.log('Starting sensor listeners...');
        
        // Listen for device motion events (accelerometer + gyroscope)
        window.addEventListener('devicemotion', (event) => {
            console.log('DeviceMotion event received:', event);
            
            if (event.accelerationIncludingGravity) {
                const accel = event.accelerationIncludingGravity;
                this.accelData.textContent = `x: ${(accel.x || 0).toFixed(2)}, y: ${(accel.y || 0).toFixed(2)}, z: ${(accel.z || 0).toFixed(2)}`;
            }
            
            if (event.rotationRate) {
                const gyro = event.rotationRate;
                this.gyroData.textContent = `α: ${(gyro.alpha || 0).toFixed(2)}, β: ${(gyro.beta || 0).toFixed(2)}, γ: ${(gyro.gamma || 0).toFixed(2)}`;
            }
            
            // Record sensor data if recording
            if (this.isRecording) {
                const timestamp = Date.now() - this.startTime;
                this.sensorData.push({
                    timestamp,
                    accelerometer: event.accelerationIncludingGravity ? {
                        x: event.accelerationIncludingGravity.x || 0,
                        y: event.accelerationIncludingGravity.y || 0,
                        z: event.accelerationIncludingGravity.z || 0
                    } : null,
                    gyroscope: event.rotationRate ? {
                        alpha: event.rotationRate.alpha || 0,
                        beta: event.rotationRate.beta || 0,
                        gamma: event.rotationRate.gamma || 0
                    } : null,
                    interval: event.interval || 0
                });
            }
        }, { passive: true });
        
        // Also listen for device orientation events as backup
        window.addEventListener('deviceorientation', (event) => {
            console.log('DeviceOrientation event received:', event);
            
            // If we don't have gyro data from devicemotion, use orientation
            if (!this.gyroData.textContent.includes('α:') || this.gyroData.textContent.includes('0.00')) {
                this.gyroData.textContent = `α: ${(event.alpha || 0).toFixed(2)}, β: ${(event.beta || 0).toFixed(2)}, γ: ${(event.gamma || 0).toFixed(2)}`;
            }
        }, { passive: true });
        
        this.sensorsInitialized = true;
        
        // Test if sensors are actually working after a short delay
        setTimeout(() => {
            if (this.accelData.textContent.includes('x: 0, y: 0, z: 0')) {
                this.statusText.textContent = 'Sensors may not be working - try moving device';
            }
        }, 2000);
    }
    
    async startRecording() {
        if (!this.stream) {
            this.statusText.textContent = 'Camera not available';
            return;
        }
        
        if (!this.sensorsInitialized) {
            this.statusText.textContent = 'Please request sensor permissions first';
            return;
        }
        
        try {
            // Clear previous data
            this.recordedChunks = [];
            this.sensorData = [];
            
            // Setup media recorder with better iOS compatibility
            const options = { mimeType: 'video/mp4' };
            
            // Try different codecs for better iOS compatibility
            if (MediaRecorder.isTypeSupported('video/mp4; codecs=avc1.42E01E,mp4a.40.2')) {
                options.mimeType = 'video/mp4; codecs=avc1.42E01E,mp4a.40.2';
            } else if (MediaRecorder.isTypeSupported('video/webm; codecs=vp8,opus')) {
                options.mimeType = 'video/webm; codecs=vp8,opus';
            } else if (MediaRecorder.isTypeSupported('video/webm')) {
                options.mimeType = 'video/webm';
            }
            
            console.log('Using MIME type:', options.mimeType);
            
            this.mediaRecorder = new MediaRecorder(this.stream, options);
            
            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.recordedChunks.push(event.data);
                }
            };
            
            this.mediaRecorder.onstop = () => {
                this.downloadBtn.disabled = false;
            };
            
            this.mediaRecorder.onerror = (event) => {
                console.error('MediaRecorder error:', event);
                this.statusText.textContent = 'Recording error occurred';
            };
            
            // Start recording
            this.mediaRecorder.start(100); // Record in 100ms chunks
            this.isRecording = true;
            this.startTime = Date.now();
            
            // Update UI
            this.startBtn.disabled = true;
            this.stopBtn.disabled = false;
            this.downloadBtn.disabled = true;
            this.statusText.textContent = 'Recording...';
            
            // Start timer
            this.startTimer();
            
        } catch (error) {
            console.error('Error starting recording:', error);
            this.statusText.textContent = 'Error starting recording: ' + error.message;
        }
    }
    
    stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.isRecording = false;
            
            // Update UI
            this.startBtn.disabled = false;
            this.stopBtn.disabled = true;
            this.statusText.textContent = `Recording stopped - ${this.sensorData.length} sensor samples collected`;
            
            // Stop timer
            this.stopTimer();
        }
    }
    
    startTimer() {
        this.timerInterval = setInterval(() => {
            if (this.startTime) {
                const elapsed = Date.now() - this.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                this.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }
    
    stopTimer() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.timerInterval = null;
        }
    }
    
    downloadData() {
        if (this.recordedChunks.length === 0) {
            this.statusText.textContent = 'No recording to download';
            return;
        }
        
        // Create video blob
        const videoBlob = new Blob(this.recordedChunks, { type: 'video/mp4' });
        
        // Create sensor data JSON with metadata
        const dataPackage = {
            metadata: {
                recordingStart: new Date(this.startTime).toISOString(),
                duration: Date.now() - this.startTime,
                sampleCount: this.sensorData.length,
                userAgent: navigator.userAgent
            },
            sensorData: this.sensorData
        };
        
        const sensorBlob = new Blob([JSON.stringify(dataPackage, null, 2)], { 
            type: 'application/json' 
        });
        
        // Create combined data package
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        
        // Download video
        const videoUrl = URL.createObjectURL(videoBlob);
        const videoLink = document.createElement('a');
        videoLink.href = videoUrl;
        videoLink.download = `recording_${timestamp}.mp4`;
        document.body.appendChild(videoLink);
        videoLink.click();
        document.body.removeChild(videoLink);
        URL.revokeObjectURL(videoUrl);
        
        // Download sensor data
        const sensorUrl = URL.createObjectURL(sensorBlob);
        const sensorLink = document.createElement('a');
        sensorLink.href = sensorUrl;
        sensorLink.download = `sensor_data_${timestamp}.json`;
        document.body.appendChild(sensorLink);
        sensorLink.click();
        document.body.removeChild(sensorLink);
        URL.revokeObjectURL(sensorUrl);
        
        this.statusText.textContent = 'Files downloaded successfully';
    }
}

// Initialize the app when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new VideoSensorRecorder();
});

// Handle page visibility changes (important for iOS)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('Page hidden');
    } else {
        console.log('Page visible');
    }
});

// Add some debugging for iOS
window.addEventListener('load', () => {
    console.log('Page loaded');
    console.log('DeviceMotionEvent available:', typeof DeviceMotionEvent !== 'undefined');
    console.log('DeviceMotionEvent.requestPermission available:', typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function');
    console.log('User agent:', navigator.userAgent);
});
  </script>
 </body>
</html>
