<!DOCTYPE html>
<html lang="en">
 <head>
  <script type="importmap">
   {
  "imports": {
    "app": "data:text/javascript;base64,Y2xhc3MgVmlkZW9TZW5zb3JSZWNvcmRlciB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLm1lZGlhUmVjb3JkZXIgPSBudWxsOwogICAgICAgIHRoaXMuc3RyZWFtID0gbnVsbDsKICAgICAgICB0aGlzLnJlY29yZGVkQ2h1bmtzID0gW107CiAgICAgICAgdGhpcy5zZW5zb3JEYXRhID0gW107CiAgICAgICAgdGhpcy5pc1JlY29yZGluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuc3RhcnRUaW1lID0gbnVsbDsKICAgICAgICB0aGlzLnRpbWVySW50ZXJ2YWwgPSBudWxsOwogICAgICAgIAogICAgICAgIHRoaXMuaW5pdGlhbGl6ZUVsZW1lbnRzKCk7CiAgICAgICAgdGhpcy5iaW5kRXZlbnRzKCk7CiAgICAgICAgdGhpcy5pbml0aWFsaXplQ2FtZXJhKCk7CiAgICB9CiAgICAKICAgIGluaXRpYWxpemVFbGVtZW50cygpIHsKICAgICAgICB0aGlzLnZpZGVvUHJldmlldyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2aWRlb1ByZXZpZXcnKTsKICAgICAgICB0aGlzLnN0YXJ0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXJ0QnRuJyk7CiAgICAgICAgdGhpcy5zdG9wQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0b3BCdG4nKTsKICAgICAgICB0aGlzLmRvd25sb2FkQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rvd25sb2FkQnRuJyk7CiAgICAgICAgdGhpcy5zdGF0dXNUZXh0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXR1c1RleHQnKTsKICAgICAgICB0aGlzLnRpbWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpbWVyJyk7CiAgICAgICAgdGhpcy5hY2NlbERhdGEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWNjZWxEYXRhJyk7CiAgICAgICAgdGhpcy5neXJvRGF0YSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdneXJvRGF0YScpOwogICAgICAgIHRoaXMucmVxdWVzdFBlcm1pc3Npb25zQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlcXVlc3RQZXJtaXNzaW9ucycpOwogICAgfQogICAgCiAgICBiaW5kRXZlbnRzKCkgewogICAgICAgIHRoaXMuc3RhcnRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB0aGlzLnN0YXJ0UmVjb3JkaW5nKCkpOwogICAgICAgIHRoaXMuc3RvcEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuc3RvcFJlY29yZGluZygpKTsKICAgICAgICB0aGlzLmRvd25sb2FkQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5kb3dubG9hZERhdGEoKSk7CiAgICAgICAgdGhpcy5yZXF1ZXN0UGVybWlzc2lvbnNCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB0aGlzLnJlcXVlc3RQZXJtaXNzaW9ucygpKTsKICAgIH0KICAgIAogICAgYXN5bmMgaW5pdGlhbGl6ZUNhbWVyYSgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLnN0cmVhbSA9IGF3YWl0IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHsKICAgICAgICAgICAgICAgIHZpZGVvOiB7IAogICAgICAgICAgICAgICAgICAgIGZhY2luZ01vZGU6ICdlbnZpcm9ubWVudCcsCiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHsgaWRlYWw6IDEyODAgfSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHsgaWRlYWw6IDcyMCB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYXVkaW86IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMudmlkZW9QcmV2aWV3LnNyY09iamVjdCA9IHRoaXMuc3RyZWFtOwogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnQ2FtZXJhIHJlYWR5JzsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBhY2Nlc3NpbmcgY2FtZXJhOicsIGVycm9yKTsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0NhbWVyYSBhY2Nlc3MgZGVuaWVkJzsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGFzeW5jIHJlcXVlc3RQZXJtaXNzaW9ucygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBSZXF1ZXN0IGRldmljZSBtb3Rpb24gcGVybWlzc2lvbiAoaU9TIDEzKykKICAgICAgICAgICAgaWYgKHR5cGVvZiBEZXZpY2VNb3Rpb25FdmVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIERldmljZU1vdGlvbkV2ZW50LnJlcXVlc3RQZXJtaXNzaW9uID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwZXJtaXNzaW9uID0gYXdhaXQgRGV2aWNlTW90aW9uRXZlbnQucmVxdWVzdFBlcm1pc3Npb24oKTsKICAgICAgICAgICAgICAgIGlmIChwZXJtaXNzaW9uID09PSAnZ3JhbnRlZCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0U2Vuc29yTGlzdGVuaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ1NlbnNvciBwZXJtaXNzaW9ucyBncmFudGVkJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ1NlbnNvciBwZXJtaXNzaW9ucyBkZW5pZWQnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRm9yIG5vbi1pT1MgZGV2aWNlcyBvciBvbGRlciBpT1MgdmVyc2lvbnMKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZW5zb3JMaXN0ZW5pbmcoKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdTZW5zb3JzIGF2YWlsYWJsZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciByZXF1ZXN0aW5nIHBlcm1pc3Npb25zOicsIGVycm9yKTsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0Vycm9yIHJlcXVlc3RpbmcgcGVybWlzc2lvbnMnOwogICAgICAgIH0KICAgIH0KICAgIAogICAgc3RhcnRTZW5zb3JMaXN0ZW5pbmcoKSB7CiAgICAgICAgLy8gTGlzdGVuIGZvciBkZXZpY2UgbW90aW9uIGV2ZW50cwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2Vtb3Rpb24nLCAoZXZlbnQpID0+IHsKICAgICAgICAgICAgaWYgKGV2ZW50LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFjY2VsID0gZXZlbnQuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eTsKICAgICAgICAgICAgICAgIHRoaXMuYWNjZWxEYXRhLnRleHRDb250ZW50ID0gYHg6ICR7YWNjZWwueD8udG9GaXhlZCgyKSB8fCAwfSwgeTogJHthY2NlbC55Py50b0ZpeGVkKDIpIHx8IDB9LCB6OiAke2FjY2VsLno/LnRvRml4ZWQoMikgfHwgMH1gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZXZlbnQucm90YXRpb25SYXRlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBneXJvID0gZXZlbnQucm90YXRpb25SYXRlOwogICAgICAgICAgICAgICAgdGhpcy5neXJvRGF0YS50ZXh0Q29udGVudCA9IGB4OiAke2d5cm8uYWxwaGE/LnRvRml4ZWQoMikgfHwgMH0sIHk6ICR7Z3lyby5iZXRhPy50b0ZpeGVkKDIpIHx8IDB9LCB6OiAke2d5cm8uZ2FtbWE/LnRvRml4ZWQoMikgfHwgMH1gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZWNvcmQgc2Vuc29yIGRhdGEgaWYgcmVjb3JkaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmlzUmVjb3JkaW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWU7CiAgICAgICAgICAgICAgICB0aGlzLnNlbnNvckRhdGEucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wLAogICAgICAgICAgICAgICAgICAgIGFjY2VsZXJvbWV0ZXI6IGV2ZW50LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHkgPyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHg6IGV2ZW50LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHkueCB8fCAwLAogICAgICAgICAgICAgICAgICAgICAgICB5OiBldmVudC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5LnkgfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgejogZXZlbnQuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eS56IHx8IDAKICAgICAgICAgICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBneXJvc2NvcGU6IGV2ZW50LnJvdGF0aW9uUmF0ZSA/IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGE6IGV2ZW50LnJvdGF0aW9uUmF0ZS5hbHBoYSB8fCAwLAogICAgICAgICAgICAgICAgICAgICAgICBiZXRhOiBldmVudC5yb3RhdGlvblJhdGUuYmV0YSB8fCAwLAogICAgICAgICAgICAgICAgICAgICAgICBnYW1tYTogZXZlbnQucm90YXRpb25SYXRlLmdhbW1hIHx8IDAKICAgICAgICAgICAgICAgICAgICB9IDogbnVsbAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIAogICAgYXN5bmMgc3RhcnRSZWNvcmRpbmcoKSB7CiAgICAgICAgaWYgKCF0aGlzLnN0cmVhbSkgewogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnQ2FtZXJhIG5vdCBhdmFpbGFibGUnOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzIGRhdGEKICAgICAgICAgICAgdGhpcy5yZWNvcmRlZENodW5rcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNlbnNvckRhdGEgPSBbXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNldHVwIG1lZGlhIHJlY29yZGVyCiAgICAgICAgICAgIHRoaXMubWVkaWFSZWNvcmRlciA9IG5ldyBNZWRpYVJlY29yZGVyKHRoaXMuc3RyZWFtLCB7CiAgICAgICAgICAgICAgICBtaW1lVHlwZTogJ3ZpZGVvL21wNDsgY29kZWNzPWF2YzEuNDJFMDFFLG1wNGEuNDAuMicKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1lZGlhUmVjb3JkZXIub25kYXRhYXZhaWxhYmxlID0gKGV2ZW50KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuZGF0YS5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb3JkZWRDaHVua3MucHVzaChldmVudC5kYXRhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVkaWFSZWNvcmRlci5vbnN0b3AgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmRvd25sb2FkQnRuLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGFydCByZWNvcmRpbmcKICAgICAgICAgICAgdGhpcy5tZWRpYVJlY29yZGVyLnN0YXJ0KDEwMCk7IC8vIFJlY29yZCBpbiAxMDBtcyBjaHVua3MKICAgICAgICAgICAgdGhpcy5pc1JlY29yZGluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSQogICAgICAgICAgICB0aGlzLnN0YXJ0QnRuLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdG9wQnRuLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZG93bmxvYWRCdG4uZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnUmVjb3JkaW5nLi4uJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXJ0IHRpbWVyCiAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lcigpOwogICAgICAgICAgICAKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBzdGFydGluZyByZWNvcmRpbmc6JywgZXJyb3IpOwogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnRXJyb3Igc3RhcnRpbmcgcmVjb3JkaW5nJzsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHN0b3BSZWNvcmRpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMubWVkaWFSZWNvcmRlciAmJiB0aGlzLmlzUmVjb3JkaW5nKSB7CiAgICAgICAgICAgIHRoaXMubWVkaWFSZWNvcmRlci5zdG9wKCk7CiAgICAgICAgICAgIHRoaXMuaXNSZWNvcmRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSQogICAgICAgICAgICB0aGlzLnN0YXJ0QnRuLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc3RvcEJ0bi5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdSZWNvcmRpbmcgc3RvcHBlZCc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9wIHRpbWVyCiAgICAgICAgICAgIHRoaXMuc3RvcFRpbWVyKCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICBzdGFydFRpbWVyKCkgewogICAgICAgIHRoaXMudGltZXJJbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhcnRUaW1lKSB7CiAgICAgICAgICAgICAgICBjb25zdCBlbGFwc2VkID0gRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lOwogICAgICAgICAgICAgICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IoZWxhcHNlZCAvIDYwMDAwKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKChlbGFwc2VkICUgNjAwMDApIC8gMTAwMCk7CiAgICAgICAgICAgICAgICB0aGlzLnRpbWVyLnRleHRDb250ZW50ID0gYCR7bWludXRlcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7c2Vjb25kcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDsKICAgICAgICAgICAgfQogICAgICAgIH0sIDEwMDApOwogICAgfQogICAgCiAgICBzdG9wVGltZXIoKSB7CiAgICAgICAgaWYgKHRoaXMudGltZXJJbnRlcnZhbCkgewogICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMudGltZXJJbnRlcnZhbCk7CiAgICAgICAgICAgIHRoaXMudGltZXJJbnRlcnZhbCA9IG51bGw7CiAgICAgICAgfQogICAgfQogICAgCiAgICBkb3dubG9hZERhdGEoKSB7CiAgICAgICAgaWYgKHRoaXMucmVjb3JkZWRDaHVua3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdObyByZWNvcmRpbmcgdG8gZG93bmxvYWQnOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIENyZWF0ZSB2aWRlbyBibG9iCiAgICAgICAgY29uc3QgdmlkZW9CbG9iID0gbmV3IEJsb2IodGhpcy5yZWNvcmRlZENodW5rcywgeyB0eXBlOiAndmlkZW8vbXA0JyB9KTsKICAgICAgICAKICAgICAgICAvLyBDcmVhdGUgc2Vuc29yIGRhdGEgSlNPTgogICAgICAgIGNvbnN0IHNlbnNvckJsb2IgPSBuZXcgQmxvYihbSlNPTi5zdHJpbmdpZnkodGhpcy5zZW5zb3JEYXRhLCBudWxsLCAyKV0sIHsgCiAgICAgICAgICAgIHR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyAKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICAvLyBDcmVhdGUgY29tYmluZWQgZGF0YSBwYWNrYWdlCiAgICAgICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnJlcGxhY2UoL1s6Ll0vZywgJy0nKTsKICAgICAgICAKICAgICAgICAvLyBEb3dubG9hZCB2aWRlbwogICAgICAgIGNvbnN0IHZpZGVvVXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTCh2aWRlb0Jsb2IpOwogICAgICAgIGNvbnN0IHZpZGVvTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICB2aWRlb0xpbmsuaHJlZiA9IHZpZGVvVXJsOwogICAgICAgIHZpZGVvTGluay5kb3dubG9hZCA9IGByZWNvcmRpbmdfJHt0aW1lc3RhbXB9Lm1wNGA7CiAgICAgICAgdmlkZW9MaW5rLmNsaWNrKCk7CiAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh2aWRlb1VybCk7CiAgICAgICAgCiAgICAgICAgLy8gRG93bmxvYWQgc2Vuc29yIGRhdGEKICAgICAgICBjb25zdCBzZW5zb3JVcmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHNlbnNvckJsb2IpOwogICAgICAgIGNvbnN0IHNlbnNvckxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgc2Vuc29yTGluay5ocmVmID0gc2Vuc29yVXJsOwogICAgICAgIHNlbnNvckxpbmsuZG93bmxvYWQgPSBgc2Vuc29yX2RhdGFfJHt0aW1lc3RhbXB9Lmpzb25gOwogICAgICAgIHNlbnNvckxpbmsuY2xpY2soKTsKICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHNlbnNvclVybCk7CiAgICAgICAgCiAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0ZpbGVzIGRvd25sb2FkZWQnOwogICAgfQp9CgovLyBJbml0aWFsaXplIHRoZSBhcHAgd2hlbiB0aGUgcGFnZSBsb2Fkcwpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKCkgPT4gewogICAgbmV3IFZpZGVvU2Vuc29yUmVjb3JkZXIoKTsKfSk7CgovLyBIYW5kbGUgcGFnZSB2aXNpYmlsaXR5IGNoYW5nZXMgKGltcG9ydGFudCBmb3IgaU9TKQpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd2aXNpYmlsaXR5Y2hhbmdlJywgKCkgPT4gewogICAgaWYgKGRvY3VtZW50LmhpZGRlbikgewogICAgICAgIC8vIFBhZ2UgaXMgaGlkZGVuLCB5b3UgbWlnaHQgd2FudCB0byBwYXVzZSByZWNvcmRpbmcgb3IgaGFuZGxlIGFjY29yZGluZ2x5CiAgICAgICAgY29uc29sZS5sb2coJ1BhZ2UgaGlkZGVuJyk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIFBhZ2UgaXMgdmlzaWJsZSBhZ2FpbgogICAgICAgIGNvbnNvbGUubG9nKCdQYWdlIHZpc2libGUnKTsKICAgIH0KfSk7Cg=="
  }
}
  </script>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Video + Sensor Recorder
  </title>
  <link href="data:text/css;base64,KiB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKfQoKYm9keSB7CiAgICBmb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAnU2Vnb2UgVUknLCBSb2JvdG8sIHNhbnMtc2VyaWY7CiAgICBiYWNrZ3JvdW5kOiAjZjVmNWY1OwogICAgcGFkZGluZzogMjBweDsKfQoKLmNvbnRhaW5lciB7CiAgICBtYXgtd2lkdGg6IDYwMHB4OwogICAgbWFyZ2luOiAwIGF1dG87CiAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICBwYWRkaW5nOiAyMHB4OwogICAgYm94LXNoYWRvdzogMCAycHggMTBweCByZ2JhKDAsMCwwLDAuMSk7Cn0KCmgxIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGNvbG9yOiAjMzMzOwogICAgbWFyZ2luLWJvdHRvbTogMjBweDsKfQoKLnZpZGVvLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTAwJTsKICAgIG1heC13aWR0aDogNDAwcHg7CiAgICBtYXJnaW46IDAgYXV0byAyMHB4OwogICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJhY2tncm91bmQ6ICMwMDA7Cn0KCiN2aWRlb1ByZXZpZXcgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IGF1dG87CiAgICBkaXNwbGF5OiBibG9jazsKfQoKLmNvbnRyb2xzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDEwcHg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDIwcHg7CiAgICBmbGV4LXdyYXA6IHdyYXA7Cn0KCi5idG4gewogICAgcGFkZGluZzogMTJweCAyNHB4OwogICAgYm9yZGVyOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgZm9udC1zaXplOiAxNnB4OwogICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgbWluLXdpZHRoOiAxMjBweDsKfQoKLmJ0bi1zdGFydCB7CiAgICBiYWNrZ3JvdW5kOiAjNENBRjUwOwogICAgY29sb3I6IHdoaXRlOwp9CgouYnRuLXN0YXJ0OmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgIGJhY2tncm91bmQ6ICM0NWEwNDk7Cn0KCi5idG4tc3RvcCB7CiAgICBiYWNrZ3JvdW5kOiAjZjQ0MzM2OwogICAgY29sb3I6IHdoaXRlOwp9CgouYnRuLXN0b3A6aG92ZXI6bm90KDpkaXNhYmxlZCkgewogICAgYmFja2dyb3VuZDogI2RhMTkwYjsKfQoKLmJ0bi1kb3dubG9hZCB7CiAgICBiYWNrZ3JvdW5kOiAjMjE5NkYzOwogICAgY29sb3I6IHdoaXRlOwp9CgouYnRuLWRvd25sb2FkOmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgIGJhY2tncm91bmQ6ICMwYjdkZGE7Cn0KCi5idG4tc2Vjb25kYXJ5IHsKICAgIGJhY2tncm91bmQ6ICNmZjk4MDA7CiAgICBjb2xvcjogd2hpdGU7Cn0KCi5idG4tc2Vjb25kYXJ5OmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgIGJhY2tncm91bmQ6ICNlNjg5MDA7Cn0KCi5idG46ZGlzYWJsZWQgewogICAgb3BhY2l0eTogMC41OwogICAgY3Vyc29yOiBub3QtYWxsb3dlZDsKfQoKLnN0YXR1cyB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiAyMHB4Owp9Cgojc3RhdHVzVGV4dCB7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBjb2xvcjogIzY2NjsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQoKI3RpbWVyIHsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6ICMzMzM7CiAgICBmb250LWZhbWlseTogJ0NvdXJpZXIgTmV3JywgbW9ub3NwYWNlOwp9Cgouc2Vuc29yLWRhdGEgewogICAgYmFja2dyb3VuZDogI2Y4ZjlmYTsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICBtYXJnaW4tYm90dG9tOiAyMHB4Owp9Cgouc2Vuc29yLWRhdGEgaDMgewogICAgbWFyZ2luLWJvdHRvbTogMTBweDsKICAgIGNvbG9yOiAjMzMzOwp9Cgouc2Vuc29yLXJvdyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTRweDsKfQoKLnNlbnNvci1yb3cgc3BhbjpmaXJzdC1jaGlsZCB7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjNTU1Owp9CgoucGVybWlzc2lvbnMgewogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgpAbWVkaWEgKG1heC13aWR0aDogNDgwcHgpIHsKICAgIC5jb250YWluZXIgewogICAgICAgIHBhZGRpbmc6IDE1cHg7CiAgICB9CiAgICAKICAgIC5jb250cm9scyB7CiAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgfQogICAgCiAgICAuYnRuIHsKICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICBtYXgtd2lkdGg6IDIwMHB4OwogICAgfQp9Cg==" rel="stylesheet"/>
 </head>
 <body>
  <div class="container">
   <h1>
    Video + Sensor Recorder
   </h1>
   <div class="video-container">
    <video autoplay="" id="videoPreview" muted="" playsinline="">
    </video>
   </div>
   <div class="controls">
    <button class="btn btn-start" id="startBtn">
     Start Recording
    </button>
    <button class="btn btn-stop" disabled="" id="stopBtn">
     Stop Recording
    </button>
    <button class="btn btn-download" disabled="" id="downloadBtn">
     Download Data
    </button>
   </div>
   <div class="status">
    <div id="statusText">
     Ready to record
    </div>
    <div id="timer">
     00:00
    </div>
   </div>
   <div class="sensor-data">
    <h3>
     Live Sensor Data
    </h3>
    <div class="sensor-row">
     <span>
      Accelerometer:
     </span>
     <span id="accelData">
      x: 0, y: 0, z: 0
     </span>
    </div>
    <div class="sensor-row">
     <span>
      Gyroscope:
     </span>
     <span id="gyroData">
      x: 0, y: 0, z: 0
     </span>
    </div>
   </div>
   <div class="permissions">
    <button class="btn btn-secondary" id="requestPermissions">
     Request Permissions
    </button>
   </div>
  </div>
  <script>
   class VideoSensorRecorder {
    constructor() {
        this.mediaRecorder = null;
        this.stream = null;
        this.recordedChunks = [];
        this.sensorData = [];
        this.isRecording = false;
        this.startTime = null;
        this.timerInterval = null;
        
        this.initializeElements();
        this.bindEvents();
        this.initializeCamera();
    }
    
    initializeElements() {
        this.videoPreview = document.getElementById('videoPreview');
        this.startBtn = document.getElementById('startBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.statusText = document.getElementById('statusText');
        this.timer = document.getElementById('timer');
        this.accelData = document.getElementById('accelData');
        this.gyroData = document.getElementById('gyroData');
        this.requestPermissionsBtn = document.getElementById('requestPermissions');
    }
    
    bindEvents() {
        this.startBtn.addEventListener('click', () => this.startRecording());
        this.stopBtn.addEventListener('click', () => this.stopRecording());
        this.downloadBtn.addEventListener('click', () => this.downloadData());
        this.requestPermissionsBtn.addEventListener('click', () => this.requestPermissions());
    }
    
    async initializeCamera() {
        try {
            this.stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: true
            });
            this.videoPreview.srcObject = this.stream;
            this.statusText.textContent = 'Camera ready';
        } catch (error) {
            console.error('Error accessing camera:', error);
            this.statusText.textContent = 'Camera access denied';
        }
    }
    
    async requestPermissions() {
        try {
            // Request device motion permission (iOS 13+)
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                const permission = await DeviceMotionEvent.requestPermission();
                if (permission === 'granted') {
                    this.startSensorListening();
                    this.statusText.textContent = 'Sensor permissions granted';
                } else {
                    this.statusText.textContent = 'Sensor permissions denied';
                }
            } else {
                // For non-iOS devices or older iOS versions
                this.startSensorListening();
                this.statusText.textContent = 'Sensors available';
            }
        } catch (error) {
            console.error('Error requesting permissions:', error);
            this.statusText.textContent = 'Error requesting permissions';
        }
    }
    
    startSensorListening() {
        // Listen for device motion events
        window.addEventListener('devicemotion', (event) => {
            if (event.accelerationIncludingGravity) {
                const accel = event.accelerationIncludingGravity;
                this.accelData.textContent = `x: ${accel.x?.toFixed(2) || 0}, y: ${accel.y?.toFixed(2) || 0}, z: ${accel.z?.toFixed(2) || 0}`;
            }
            
            if (event.rotationRate) {
                const gyro = event.rotationRate;
                this.gyroData.textContent = `x: ${gyro.alpha?.toFixed(2) || 0}, y: ${gyro.beta?.toFixed(2) || 0}, z: ${gyro.gamma?.toFixed(2) || 0}`;
            }
            
            // Record sensor data if recording
            if (this.isRecording) {
                const timestamp = Date.now() - this.startTime;
                this.sensorData.push({
                    timestamp,
                    accelerometer: event.accelerationIncludingGravity ? {
                        x: event.accelerationIncludingGravity.x || 0,
                        y: event.accelerationIncludingGravity.y || 0,
                        z: event.accelerationIncludingGravity.z || 0
                    } : null,
                    gyroscope: event.rotationRate ? {
                        alpha: event.rotationRate.alpha || 0,
                        beta: event.rotationRate.beta || 0,
                        gamma: event.rotationRate.gamma || 0
                    } : null
                });
            }
        });
    }
    
    async startRecording() {
        if (!this.stream) {
            this.statusText.textContent = 'Camera not available';
            return;
        }
        
        try {
            // Clear previous data
            this.recordedChunks = [];
            this.sensorData = [];
            
            // Setup media recorder
            this.mediaRecorder = new MediaRecorder(this.stream, {
                mimeType: 'video/mp4; codecs=avc1.42E01E,mp4a.40.2'
            });
            
            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.recordedChunks.push(event.data);
                }
            };
            
            this.mediaRecorder.onstop = () => {
                this.downloadBtn.disabled = false;
            };
            
            // Start recording
            this.mediaRecorder.start(100); // Record in 100ms chunks
            this.isRecording = true;
            this.startTime = Date.now();
            
            // Update UI
            this.startBtn.disabled = true;
            this.stopBtn.disabled = false;
            this.downloadBtn.disabled = true;
            this.statusText.textContent = 'Recording...';
            
            // Start timer
            this.startTimer();
            
        } catch (error) {
            console.error('Error starting recording:', error);
            this.statusText.textContent = 'Error starting recording';
        }
    }
    
    stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.isRecording = false;
            
            // Update UI
            this.startBtn.disabled = false;
            this.stopBtn.disabled = true;
            this.statusText.textContent = 'Recording stopped';
            
            // Stop timer
            this.stopTimer();
        }
    }
    
    startTimer() {
        this.timerInterval = setInterval(() => {
            if (this.startTime) {
                const elapsed = Date.now() - this.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                this.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }
    
    stopTimer() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.timerInterval = null;
        }
    }
    
    downloadData() {
        if (this.recordedChunks.length === 0) {
            this.statusText.textContent = 'No recording to download';
            return;
        }
        
        // Create video blob
        const videoBlob = new Blob(this.recordedChunks, { type: 'video/mp4' });
        
        // Create sensor data JSON
        const sensorBlob = new Blob([JSON.stringify(this.sensorData, null, 2)], { 
            type: 'application/json' 
        });
        
        // Create combined data package
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        
        // Download video
        const videoUrl = URL.createObjectURL(videoBlob);
        const videoLink = document.createElement('a');
        videoLink.href = videoUrl;
        videoLink.download = `recording_${timestamp}.mp4`;
        videoLink.click();
        URL.revokeObjectURL(videoUrl);
        
        // Download sensor data
        const sensorUrl = URL.createObjectURL(sensorBlob);
        const sensorLink = document.createElement('a');
        sensorLink.href = sensorUrl;
        sensorLink.download = `sensor_data_${timestamp}.json`;
        sensorLink.click();
        URL.revokeObjectURL(sensorUrl);
        
        this.statusText.textContent = 'Files downloaded';
    }
}

// Initialize the app when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new VideoSensorRecorder();
});

// Handle page visibility changes (important for iOS)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Page is hidden, you might want to pause recording or handle accordingly
        console.log('Page hidden');
    } else {
        // Page is visible again
        console.log('Page visible');
    }
});
  </script>
 </body>
</html>
