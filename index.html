<!DOCTYPE html>
<html lang="en">
 <head>
  <script type="importmap">
   {
  "imports": {
    "app": "data:text/javascript;base64,Y2xhc3MgVmlkZW9TZW5zb3JSZWNvcmRlciB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLm1lZGlhUmVjb3JkZXIgPSBudWxsOwogICAgICAgIHRoaXMuc3RyZWFtID0gbnVsbDsKICAgICAgICB0aGlzLnJlY29yZGVkQ2h1bmtzID0gW107CiAgICAgICAgdGhpcy5zZW5zb3JEYXRhID0gW107CiAgICAgICAgdGhpcy5pc1JlY29yZGluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuc3RhcnRUaW1lID0gbnVsbDsKICAgICAgICB0aGlzLnRpbWVySW50ZXJ2YWwgPSBudWxsOwogICAgICAgIAogICAgICAgIHRoaXMuaW5pdGlhbGl6ZUVsZW1lbnRzKCk7CiAgICAgICAgdGhpcy5iaW5kRXZlbnRzKCk7CiAgICAgICAgdGhpcy5pbml0aWFsaXplQ2FtZXJhKCk7CiAgICB9CiAgICAKICAgIGluaXRpYWxpemVFbGVtZW50cygpIHsKICAgICAgICB0aGlzLnZpZGVvUHJldmlldyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2aWRlb1ByZXZpZXcnKTsKICAgICAgICB0aGlzLnN0YXJ0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXJ0QnRuJyk7CiAgICAgICAgdGhpcy5zdG9wQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0b3BCdG4nKTsKICAgICAgICB0aGlzLmRvd25sb2FkQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rvd25sb2FkQnRuJyk7CiAgICAgICAgdGhpcy5zdGF0dXNUZXh0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXR1c1RleHQnKTsKICAgICAgICB0aGlzLnRpbWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpbWVyJyk7CiAgICAgICAgdGhpcy5hY2NlbERhdGEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWNjZWxEYXRhJyk7CiAgICAgICAgdGhpcy5neXJvRGF0YSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdneXJvRGF0YScpOwogICAgICAgIHRoaXMucmVxdWVzdFBlcm1pc3Npb25zQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlcXVlc3RQZXJtaXNzaW9ucycpOwogICAgfQogICAgCiAgICBiaW5kRXZlbnRzKCkgewogICAgICAgIHRoaXMuc3RhcnRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB0aGlzLnN0YXJ0UmVjb3JkaW5nKCkpOwogICAgICAgIHRoaXMuc3RvcEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuc3RvcFJlY29yZGluZygpKTsKICAgICAgICB0aGlzLmRvd25sb2FkQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5kb3dubG9hZERhdGEoKSk7CiAgICAgICAgdGhpcy5yZXF1ZXN0UGVybWlzc2lvbnNCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB0aGlzLnJlcXVlc3RQZXJtaXNzaW9ucygpKTsKICAgIH0KICAgIAogICAgYXN5bmMgaW5pdGlhbGl6ZUNhbWVyYSgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLnN0cmVhbSA9IGF3YWl0IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHsKICAgICAgICAgICAgICAgIHZpZGVvOiB7IAogICAgICAgICAgICAgICAgICAgIGZhY2luZ01vZGU6ICdlbnZpcm9ubWVudCcsCiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHsgaWRlYWw6IDEyODAgfSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHsgaWRlYWw6IDcyMCB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYXVkaW86IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMudmlkZW9QcmV2aWV3LnNyY09iamVjdCA9IHRoaXMuc3RyZWFtOwogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnQ2FtZXJhIHJlYWR5JzsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBhY2Nlc3NpbmcgY2FtZXJhOicsIGVycm9yKTsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0NhbWVyYSBhY2Nlc3MgZGVuaWVkJzsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGFzeW5jIHJlcXVlc3RQZXJtaXNzaW9ucygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBSZXF1ZXN0IGRldmljZSBtb3Rpb24gcGVybWlzc2lvbiAoaU9TIDEzKykKICAgICAgICAgICAgaWYgKHR5cGVvZiBEZXZpY2VNb3Rpb25FdmVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIERldmljZU1vdGlvbkV2ZW50LnJlcXVlc3RQZXJtaXNzaW9uID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwZXJtaXNzaW9uID0gYXdhaXQgRGV2aWNlTW90aW9uRXZlbnQucmVxdWVzdFBlcm1pc3Npb24oKTsKICAgICAgICAgICAgICAgIGlmIChwZXJtaXNzaW9uID09PSAnZ3JhbnRlZCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0U2Vuc29yTGlzdGVuaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ1NlbnNvciBwZXJtaXNzaW9ucyBncmFudGVkJzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ1NlbnNvciBwZXJtaXNzaW9ucyBkZW5pZWQnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRm9yIG5vbi1pT1MgZGV2aWNlcyBvciBvbGRlciBpT1MgdmVyc2lvbnMKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZW5zb3JMaXN0ZW5pbmcoKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdTZW5zb3JzIGF2YWlsYWJsZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciByZXF1ZXN0aW5nIHBlcm1pc3Npb25zOicsIGVycm9yKTsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0Vycm9yIHJlcXVlc3RpbmcgcGVybWlzc2lvbnMnOwogICAgICAgIH0KICAgIH0KICAgIAogICAgc3RhcnRTZW5zb3JMaXN0ZW5pbmcoKSB7CiAgICAgICAgLy8gTGlzdGVuIGZvciBkZXZpY2UgbW90aW9uIGV2ZW50cwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2Vtb3Rpb24nLCAoZXZlbnQpID0+IHsKICAgICAgICAgICAgaWYgKGV2ZW50LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFjY2VsID0gZXZlbnQuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eTsKICAgICAgICAgICAgICAgIHRoaXMuYWNjZWxEYXRhLnRleHRDb250ZW50ID0gYHg6ICR7YWNjZWwueD8udG9GaXhlZCgyKSB8fCAwfSwgeTogJHthY2NlbC55Py50b0ZpeGVkKDIpIHx8IDB9LCB6OiAke2FjY2VsLno/LnRvRml4ZWQoMikgfHwgMH1gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZXZlbnQucm90YXRpb25SYXRlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBneXJvID0gZXZlbnQucm90YXRpb25SYXRlOwogICAgICAgICAgICAgICAgdGhpcy5neXJvRGF0YS50ZXh0Q29udGVudCA9IGB4OiAke2d5cm8uYWxwaGE/LnRvRml4ZWQoMikgfHwgMH0sIHk6ICR7Z3lyby5iZXRhPy50b0ZpeGVkKDIpIHx8IDB9LCB6OiAke2d5cm8uZ2FtbWE/LnRvRml4ZWQoMikgfHwgMH1gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZWNvcmQgc2Vuc29yIGRhdGEgaWYgcmVjb3JkaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmlzUmVjb3JkaW5nKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWU7CiAgICAgICAgICAgICAgICB0aGlzLnNlbnNvckRhdGEucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wLAogICAgICAgICAgICAgICAgICAgIGFjY2VsZXJvbWV0ZXI6IGV2ZW50LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHkgPyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHg6IGV2ZW50LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHkueCB8fCAwLAogICAgICAgICAgICAgICAgICAgICAgICB5OiBldmVudC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5LnkgfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgejogZXZlbnQuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eS56IHx8IDAKICAgICAgICAgICAgICAgICAgICB9IDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBneXJvc2NvcGU6IGV2ZW50LnJvdGF0aW9uUmF0ZSA/IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWxwaGE6IGV2ZW50LnJvdGF0aW9uUmF0ZS5hbHBoYSB8fCAwLAogICAgICAgICAgICAgICAgICAgICAgICBiZXRhOiBldmVudC5yb3RhdGlvblJhdGUuYmV0YSB8fCAwLAogICAgICAgICAgICAgICAgICAgICAgICBnYW1tYTogZXZlbnQucm90YXRpb25SYXRlLmdhbW1hIHx8IDAKICAgICAgICAgICAgICAgICAgICB9IDogbnVsbAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIAogICAgYXN5bmMgc3RhcnRSZWNvcmRpbmcoKSB7CiAgICAgICAgaWYgKCF0aGlzLnN0cmVhbSkgewogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnQ2FtZXJhIG5vdCBhdmFpbGFibGUnOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIENsZWFyIHByZXZpb3VzIGRhdGEKICAgICAgICAgICAgdGhpcy5yZWNvcmRlZENodW5rcyA9IFtdOwogICAgICAgICAgICB0aGlzLnNlbnNvckRhdGEgPSBbXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRyeSBkaWZmZXJlbnQgTUlNRSB0eXBlcyBmb3IgYmV0dGVyIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgbGV0IG1pbWVUeXBlID0gJ3ZpZGVvL3dlYm07Y29kZWNzPXZwOSc7CiAgICAgICAgICAgIGlmICghTWVkaWFSZWNvcmRlci5pc1R5cGVTdXBwb3J0ZWQobWltZVR5cGUpKSB7CiAgICAgICAgICAgICAgICBtaW1lVHlwZSA9ICd2aWRlby93ZWJtO2NvZGVjcz12cDgnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghTWVkaWFSZWNvcmRlci5pc1R5cGVTdXBwb3J0ZWQobWltZVR5cGUpKSB7CiAgICAgICAgICAgICAgICBtaW1lVHlwZSA9ICd2aWRlby93ZWJtJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIU1lZGlhUmVjb3JkZXIuaXNUeXBlU3VwcG9ydGVkKG1pbWVUeXBlKSkgewogICAgICAgICAgICAgICAgbWltZVR5cGUgPSAndmlkZW8vbXA0JzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0dXAgbWVkaWEgcmVjb3JkZXIKICAgICAgICAgICAgdGhpcy5tZWRpYVJlY29yZGVyID0gbmV3IE1lZGlhUmVjb3JkZXIodGhpcy5zdHJlYW0sIHsKICAgICAgICAgICAgICAgIG1pbWVUeXBlOiBtaW1lVHlwZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubWVkaWFSZWNvcmRlci5vbmRhdGFhdmFpbGFibGUgPSAoZXZlbnQpID0+IHsKICAgICAgICAgICAgICAgIGlmIChldmVudC5kYXRhLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRlZENodW5rcy5wdXNoKGV2ZW50LmRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZWRpYVJlY29yZGVyLm9uc3RvcCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuZG93bmxvYWRCdG4uZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0YXJ0IHJlY29yZGluZwogICAgICAgICAgICB0aGlzLm1lZGlhUmVjb3JkZXIuc3RhcnQoMTAwKTsgLy8gUmVjb3JkIGluIDEwMG1zIGNodW5rcwogICAgICAgICAgICB0aGlzLmlzUmVjb3JkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFVJCiAgICAgICAgICAgIHRoaXMuc3RhcnRCdG4uZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnN0b3BCdG4uZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kb3dubG9hZEJ0bi5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdSZWNvcmRpbmcuLi4nOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RhcnQgdGltZXIKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWVyKCk7CiAgICAgICAgICAgIAogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHN0YXJ0aW5nIHJlY29yZGluZzonLCBlcnJvcik7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdFcnJvciBzdGFydGluZyByZWNvcmRpbmcnOwogICAgICAgIH0KICAgIH0KICAgIAogICAgc3RvcFJlY29yZGluZygpIHsKICAgICAgICBpZiAodGhpcy5tZWRpYVJlY29yZGVyICYmIHRoaXMuaXNSZWNvcmRpbmcpIHsKICAgICAgICAgICAgdGhpcy5tZWRpYVJlY29yZGVyLnN0b3AoKTsKICAgICAgICAgICAgdGhpcy5pc1JlY29yZGluZyA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIFVJCiAgICAgICAgICAgIHRoaXMuc3RhcnRCdG4uZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdG9wQnRuLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ1JlY29yZGluZyBzdG9wcGVkJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0b3AgdGltZXIKICAgICAgICAgICAgdGhpcy5zdG9wVGltZXIoKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHN0YXJ0VGltZXIoKSB7CiAgICAgICAgdGhpcy50aW1lckludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gewogICAgICAgICAgICBpZiAodGhpcy5zdGFydFRpbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsYXBzZWQgPSBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWU7CiAgICAgICAgICAgICAgICBjb25zdCBtaW51dGVzID0gTWF0aC5mbG9vcihlbGFwc2VkIC8gNjAwMDApOwogICAgICAgICAgICAgICAgY29uc3Qgc2Vjb25kcyA9IE1hdGguZmxvb3IoKGVsYXBzZWQgJSA2MDAwMCkgLyAxMDAwKTsKICAgICAgICAgICAgICAgIHRoaXMudGltZXIudGV4dENvbnRlbnQgPSBgJHttaW51dGVzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX06JHtzZWNvbmRzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX1gOwogICAgICAgICAgICB9CiAgICAgICAgfSwgMTAwMCk7CiAgICB9CiAgICAKICAgIHN0b3BUaW1lcigpIHsKICAgICAgICBpZiAodGhpcy50aW1lckludGVydmFsKSB7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy50aW1lckludGVydmFsKTsKICAgICAgICAgICAgdGhpcy50aW1lckludGVydmFsID0gbnVsbDsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGFzeW5jIGRvd25sb2FkRGF0YSgpIHsKICAgICAgICBpZiAodGhpcy5yZWNvcmRlZENodW5rcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ05vIHJlY29yZGluZyB0byBkb3dubG9hZCc7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gQ3JlYXRlIHRpbWVzdGFtcCBmb3IgZmlsZW5hbWVzCiAgICAgICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IG5vdy5nZXRGdWxsWWVhcigpICsgJy0nICsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcobm93LmdldE1vbnRoKCkgKyAxKS5wYWRTdGFydCgyLCAnMCcpICsgJy0nICsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcobm93LmdldERhdGUoKSkucGFkU3RhcnQoMiwgJzAnKSArICdfJyArIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nKG5vdy5nZXRIb3VycygpKS5wYWRTdGFydCgyLCAnMCcpICsgJy0nICsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcobm93LmdldE1pbnV0ZXMoKSkucGFkU3RhcnQoMiwgJzAnKSArICctJyArIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nKG5vdy5nZXRTZWNvbmRzKCkpLnBhZFN0YXJ0KDIsICcwJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnUHJlcGFyaW5nIGRvd25sb2Fkcy4uLic7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDcmVhdGUgdmlkZW8gYmxvYgogICAgICAgICAgICBjb25zdCB2aWRlb0Jsb2IgPSBuZXcgQmxvYih0aGlzLnJlY29yZGVkQ2h1bmtzLCB7IHR5cGU6ICd2aWRlby93ZWJtJyB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENyZWF0ZSBzZW5zb3IgZGF0YSBKU09OCiAgICAgICAgICAgIGNvbnN0IHNlbnNvckRhdGFPYmogPSB7CiAgICAgICAgICAgICAgICByZWNvcmRpbmdJbmZvOiB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRUaW1lOiBuZXcgRGF0ZSh0aGlzLnN0YXJ0VGltZSkudG9JU09TdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lLAogICAgICAgICAgICAgICAgICAgIHNhbXBsZUNvdW50OiB0aGlzLnNlbnNvckRhdGEubGVuZ3RoCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2Vuc29yRGF0YTogdGhpcy5zZW5zb3JEYXRhCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzZW5zb3JCbG9iID0gbmV3IEJsb2IoW0pTT04uc3RyaW5naWZ5KHNlbnNvckRhdGFPYmosIG51bGwsIDIpXSwgeyAKICAgICAgICAgICAgICAgIHR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyAKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3IgaU9TIFNhZmFyaSwgd2UgbmVlZCB0byBoYW5kbGUgZG93bmxvYWRzIGRpZmZlcmVudGx5CiAgICAgICAgICAgIGNvbnN0IGlzSU9TID0gL2lQYWR8aVBob25lfGlQb2QvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCk7CiAgICAgICAgICAgIGNvbnN0IGlzU2FmYXJpID0gL14oKD8hY2hyb21lfGFuZHJvaWQpLikqc2FmYXJpL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc0lPUyB8fCBpc1NhZmFyaSkgewogICAgICAgICAgICAgICAgLy8gaU9TIFNhZmFyaSBhcHByb2FjaCAtIG9wZW4gaW4gbmV3IHRhYi93aW5kb3cKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdPcGVuaW5nIGZpbGVzIGluIG5ldyB0YWJzIChpT1MgU2FmYXJpKS4uLic7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFZpZGVvIGZpbGUKICAgICAgICAgICAgICAgIGNvbnN0IHZpZGVvVXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTCh2aWRlb0Jsb2IpOwogICAgICAgICAgICAgICAgY29uc3QgdmlkZW9XaW5kb3cgPSB3aW5kb3cub3Blbih2aWRlb1VybCwgJ19ibGFuaycpOwogICAgICAgICAgICAgICAgaWYgKHZpZGVvV2luZG93KSB7CiAgICAgICAgICAgICAgICAgICAgdmlkZW9XaW5kb3cuZG9jdW1lbnQudGl0bGUgPSBgcmVjb3JkaW5nXyR7dGltZXN0YW1wfS53ZWJtYDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gV2FpdCBhIGJpdAogICAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDApKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU2Vuc29yIGRhdGEgZmlsZQogICAgICAgICAgICAgICAgY29uc3Qgc2Vuc29yVXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChzZW5zb3JCbG9iKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNlbnNvcldpbmRvdyA9IHdpbmRvdy5vcGVuKHNlbnNvclVybCwgJ19ibGFuaycpOwogICAgICAgICAgICAgICAgaWYgKHNlbnNvcldpbmRvdykgewogICAgICAgICAgICAgICAgICAgIHNlbnNvcldpbmRvdy5kb2N1bWVudC50aXRsZSA9IGBzZW5zb3JfZGF0YV8ke3RpbWVzdGFtcH0uanNvbmA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9ICdGaWxlcyBvcGVuZWQgaW4gbmV3IHRhYnMuIFVzZSAiU2F2ZSBBcyIgdG8gZG93bmxvYWQuJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2xlYW4gdXAgVVJMcyBhZnRlciBkZWxheQogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh2aWRlb1VybCk7CiAgICAgICAgICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTChzZW5zb3JVcmwpOwogICAgICAgICAgICAgICAgfSwgMTAwMDApOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTdGFuZGFyZCBkb3dubG9hZCBhcHByb2FjaCBmb3Igb3RoZXIgYnJvd3NlcnMKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZG93bmxvYWRGaWxlKHZpZGVvQmxvYiwgYHJlY29yZGluZ18ke3RpbWVzdGFtcH0ud2VibWApOwogICAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDApKTsKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZG93bmxvYWRGaWxlKHNlbnNvckJsb2IsIGBzZW5zb3JfZGF0YV8ke3RpbWVzdGFtcH0uanNvbmApOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0LnRleHRDb250ZW50ID0gJ0ZpbGVzIGRvd25sb2FkZWQgc3VjY2Vzc2Z1bGx5ISc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZG93bmxvYWRpbmcgZmlsZXM6JywgZXJyb3IpOwogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHQudGV4dENvbnRlbnQgPSAnRXJyb3IgZG93bmxvYWRpbmcgZmlsZXMnOwogICAgICAgIH0KICAgIH0KICAgIAogICAgZG93bmxvYWRGaWxlKGJsb2IsIGZpbGVuYW1lKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGxpbmsuaHJlZiA9IHVybDsKICAgICAgICAgICAgbGluay5kb3dubG9hZCA9IGZpbGVuYW1lOwogICAgICAgICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGb3JjZSB1c2VyIGludGVyYWN0aW9uIGZvciBpT1MKICAgICAgICAgICAgbGluay50YXJnZXQgPSAnX2JsYW5rJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCB0byBET00sIGNsaWNrLCB0aGVuIHJlbW92ZQogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXNlIGJvdGggY2xpY2sgbWV0aG9kcyBmb3IgYmV0dGVyIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgaWYgKGxpbmsuY2xpY2spIHsKICAgICAgICAgICAgICAgIGxpbmsuY2xpY2soKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIGZvciBvbGRlciBicm93c2VycwogICAgICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgTW91c2VFdmVudCgnY2xpY2snLCB7CiAgICAgICAgICAgICAgICAgICAgdmlldzogd2luZG93LAogICAgICAgICAgICAgICAgICAgIGJ1YmJsZXM6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgY2FuY2VsYWJsZTogdHJ1ZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBsaW5rLmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGxpbmspOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xlYW4gdXAgVVJMIGFmdGVyIGEgZGVsYXkKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICAgIH0sIDIwMDApOwogICAgICAgIH0pOwogICAgfQp9CgovLyBJbml0aWFsaXplIHRoZSBhcHAgd2hlbiB0aGUgcGFnZSBsb2Fkcwpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKCkgPT4gewogICAgbmV3IFZpZGVvU2Vuc29yUmVjb3JkZXIoKTsKfSk7CgovLyBIYW5kbGUgcGFnZSB2aXNpYmlsaXR5IGNoYW5nZXMgKGltcG9ydGFudCBmb3IgaU9TKQpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd2aXNpYmlsaXR5Y2hhbmdlJywgKCkgPT4gewogICAgaWYgKGRvY3VtZW50LmhpZGRlbikgewogICAgICAgIGNvbnNvbGUubG9nKCdQYWdlIGhpZGRlbicpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZygnUGFnZSB2aXNpYmxlJyk7CiAgICB9Cn0pOwo="
  }
}
  </script>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Video + Sensor Recorder
  </title>
  <link href="data:text/css;base64,KiB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKfQoKYm9keSB7CiAgICBmb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAnU2Vnb2UgVUknLCBSb2JvdG8sIHNhbnMtc2VyaWY7CiAgICBiYWNrZ3JvdW5kOiAjZjVmNWY1OwogICAgcGFkZGluZzogMjBweDsKfQoKLmNvbnRhaW5lciB7CiAgICBtYXgtd2lkdGg6IDYwMHB4OwogICAgbWFyZ2luOiAwIGF1dG87CiAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICBwYWRkaW5nOiAyMHB4OwogICAgYm94LXNoYWRvdzogMCAycHggMTBweCByZ2JhKDAsMCwwLDAuMSk7Cn0KCmgxIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIGNvbG9yOiAjMzMzOwogICAgbWFyZ2luLWJvdHRvbTogMjBweDsKfQoKLnZpZGVvLWNvbnRhaW5lciB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB3aWR0aDogMTAwJTsKICAgIG1heC13aWR0aDogNDAwcHg7CiAgICBtYXJnaW46IDAgYXV0byAyMHB4OwogICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGJhY2tncm91bmQ6ICMwMDA7Cn0KCiN2aWRlb1ByZXZpZXcgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IGF1dG87CiAgICBkaXNwbGF5OiBibG9jazsKfQoKLmNvbnRyb2xzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDEwcHg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIG1hcmdpbi1ib3R0b206IDIwcHg7CiAgICBmbGV4LXdyYXA6IHdyYXA7Cn0KCi5idG4gewogICAgcGFkZGluZzogMTJweCAyNHB4OwogICAgYm9yZGVyOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgZm9udC1zaXplOiAxNnB4OwogICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgbWluLXdpZHRoOiAxMjBweDsKfQoKLmJ0bi1zdGFydCB7CiAgICBiYWNrZ3JvdW5kOiAjNENBRjUwOwogICAgY29sb3I6IHdoaXRlOwp9CgouYnRuLXN0YXJ0OmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgIGJhY2tncm91bmQ6ICM0NWEwNDk7Cn0KCi5idG4tc3RvcCB7CiAgICBiYWNrZ3JvdW5kOiAjZjQ0MzM2OwogICAgY29sb3I6IHdoaXRlOwp9CgouYnRuLXN0b3A6aG92ZXI6bm90KDpkaXNhYmxlZCkgewogICAgYmFja2dyb3VuZDogI2RhMTkwYjsKfQoKLmJ0bi1kb3dubG9hZCB7CiAgICBiYWNrZ3JvdW5kOiAjMjE5NkYzOwogICAgY29sb3I6IHdoaXRlOwp9CgouYnRuLWRvd25sb2FkOmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgIGJhY2tncm91bmQ6ICMwYjdkZGE7Cn0KCi5idG4tc2Vjb25kYXJ5IHsKICAgIGJhY2tncm91bmQ6ICNmZjk4MDA7CiAgICBjb2xvcjogd2hpdGU7Cn0KCi5idG4tc2Vjb25kYXJ5OmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgIGJhY2tncm91bmQ6ICNlNjg5MDA7Cn0KCi5idG46ZGlzYWJsZWQgewogICAgb3BhY2l0eTogMC41OwogICAgY3Vyc29yOiBub3QtYWxsb3dlZDsKfQoKLnN0YXR1cyB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBtYXJnaW4tYm90dG9tOiAyMHB4Owp9Cgojc3RhdHVzVGV4dCB7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBjb2xvcjogIzY2NjsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKfQoKI3RpbWVyIHsKICAgIGZvbnQtc2l6ZTogMjRweDsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgY29sb3I6ICMzMzM7CiAgICBmb250LWZhbWlseTogJ0NvdXJpZXIgTmV3JywgbW9ub3NwYWNlOwp9Cgouc2Vuc29yLWRhdGEgewogICAgYmFja2dyb3VuZDogI2Y4ZjlmYTsKICAgIHBhZGRpbmc6IDE1cHg7CiAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICBtYXJnaW4tYm90dG9tOiAyMHB4Owp9Cgouc2Vuc29yLWRhdGEgaDMgewogICAgbWFyZ2luLWJvdHRvbTogMTBweDsKICAgIGNvbG9yOiAjMzMzOwp9Cgouc2Vuc29yLXJvdyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgZm9udC1mYW1pbHk6ICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTRweDsKfQoKLnNlbnNvci1yb3cgc3BhbjpmaXJzdC1jaGlsZCB7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjNTU1Owp9CgoucGVybWlzc2lvbnMgewogICAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgpAbWVkaWEgKG1heC13aWR0aDogNDgwcHgpIHsKICAgIC5jb250YWluZXIgewogICAgICAgIHBhZGRpbmc6IDE1cHg7CiAgICB9CiAgICAKICAgIC5jb250cm9scyB7CiAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgfQogICAgCiAgICAuYnRuIHsKICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICBtYXgtd2lkdGg6IDIwMHB4OwogICAgfQp9Cg==" rel="stylesheet"/>
 </head>
 <body>
  <div class="container">
   <h1>
    Video + Sensor Recorder
   </h1>
   <div class="video-container">
    <video autoplay="" id="videoPreview" muted="" playsinline="">
    </video>
   </div>
   <div class="controls">
    <button class="btn btn-start" id="startBtn">
     Start Recording
    </button>
    <button class="btn btn-stop" disabled="" id="stopBtn">
     Stop Recording
    </button>
    <button class="btn btn-download" disabled="" id="downloadBtn">
     Download Data
    </button>
   </div>
   <div class="status">
    <div id="statusText">
     Ready to record
    </div>
    <div id="timer">
     00:00
    </div>
   </div>
   <div class="sensor-data">
    <h3>
     Live Sensor Data
    </h3>
    <div class="sensor-row">
     <span>
      Accelerometer:
     </span>
     <span id="accelData">
      x: 0, y: 0, z: 0
     </span>
    </div>
    <div class="sensor-row">
     <span>
      Gyroscope:
     </span>
     <span id="gyroData">
      x: 0, y: 0, z: 0
     </span>
    </div>
   </div>
   <div class="permissions">
    <button class="btn btn-secondary" id="requestPermissions">
     Request Permissions
    </button>
   </div>
  </div>
  <script>
   class VideoSensorRecorder {
    constructor() {
        this.mediaRecorder = null;
        this.stream = null;
        this.recordedChunks = [];
        this.sensorData = [];
        this.isRecording = false;
        this.startTime = null;
        this.timerInterval = null;
        
        this.initializeElements();
        this.bindEvents();
        this.initializeCamera();
    }
    
    initializeElements() {
        this.videoPreview = document.getElementById('videoPreview');
        this.startBtn = document.getElementById('startBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.statusText = document.getElementById('statusText');
        this.timer = document.getElementById('timer');
        this.accelData = document.getElementById('accelData');
        this.gyroData = document.getElementById('gyroData');
        this.requestPermissionsBtn = document.getElementById('requestPermissions');
    }
    
    bindEvents() {
        this.startBtn.addEventListener('click', () => this.startRecording());
        this.stopBtn.addEventListener('click', () => this.stopRecording());
        this.downloadBtn.addEventListener('click', () => this.downloadData());
        this.requestPermissionsBtn.addEventListener('click', () => this.requestPermissions());
    }
    
    async initializeCamera() {
        try {
            this.stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: true
            });
            this.videoPreview.srcObject = this.stream;
            this.statusText.textContent = 'Camera ready';
        } catch (error) {
            console.error('Error accessing camera:', error);
            this.statusText.textContent = 'Camera access denied';
        }
    }
    
    async requestPermissions() {
        try {
            // Request device motion permission (iOS 13+)
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                const permission = await DeviceMotionEvent.requestPermission();
                if (permission === 'granted') {
                    this.startSensorListening();
                    this.statusText.textContent = 'Sensor permissions granted';
                } else {
                    this.statusText.textContent = 'Sensor permissions denied';
                }
            } else {
                // For non-iOS devices or older iOS versions
                this.startSensorListening();
                this.statusText.textContent = 'Sensors available';
            }
        } catch (error) {
            console.error('Error requesting permissions:', error);
            this.statusText.textContent = 'Error requesting permissions';
        }
    }
    
    startSensorListening() {
        // Listen for device motion events
        window.addEventListener('devicemotion', (event) => {
            if (event.accelerationIncludingGravity) {
                const accel = event.accelerationIncludingGravity;
                this.accelData.textContent = `x: ${accel.x?.toFixed(2) || 0}, y: ${accel.y?.toFixed(2) || 0}, z: ${accel.z?.toFixed(2) || 0}`;
            }
            
            if (event.rotationRate) {
                const gyro = event.rotationRate;
                this.gyroData.textContent = `x: ${gyro.alpha?.toFixed(2) || 0}, y: ${gyro.beta?.toFixed(2) || 0}, z: ${gyro.gamma?.toFixed(2) || 0}`;
            }
            
            // Record sensor data if recording
            if (this.isRecording) {
                const timestamp = Date.now() - this.startTime;
                this.sensorData.push({
                    timestamp,
                    accelerometer: event.accelerationIncludingGravity ? {
                        x: event.accelerationIncludingGravity.x || 0,
                        y: event.accelerationIncludingGravity.y || 0,
                        z: event.accelerationIncludingGravity.z || 0
                    } : null,
                    gyroscope: event.rotationRate ? {
                        alpha: event.rotationRate.alpha || 0,
                        beta: event.rotationRate.beta || 0,
                        gamma: event.rotationRate.gamma || 0
                    } : null
                });
            }
        });
    }
    
    async startRecording() {
        if (!this.stream) {
            this.statusText.textContent = 'Camera not available';
            return;
        }
        
        try {
            // Clear previous data
            this.recordedChunks = [];
            this.sensorData = [];
            
            // Try different MIME types for better compatibility
            let mimeType = 'video/webm;codecs=vp9';
            if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'video/webm;codecs=vp8';
            }
            if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'video/webm';
            }
            if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'video/mp4';
            }
            
            // Setup media recorder
            this.mediaRecorder = new MediaRecorder(this.stream, {
                mimeType: mimeType
            });
            
            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.recordedChunks.push(event.data);
                }
            };
            
            this.mediaRecorder.onstop = () => {
                this.downloadBtn.disabled = false;
            };
            
            // Start recording
            this.mediaRecorder.start(100); // Record in 100ms chunks
            this.isRecording = true;
            this.startTime = Date.now();
            
            // Update UI
            this.startBtn.disabled = true;
            this.stopBtn.disabled = false;
            this.downloadBtn.disabled = true;
            this.statusText.textContent = 'Recording...';
            
            // Start timer
            this.startTimer();
            
        } catch (error) {
            console.error('Error starting recording:', error);
            this.statusText.textContent = 'Error starting recording';
        }
    }
    
    stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.isRecording = false;
            
            // Update UI
            this.startBtn.disabled = false;
            this.stopBtn.disabled = true;
            this.statusText.textContent = 'Recording stopped';
            
            // Stop timer
            this.stopTimer();
        }
    }
    
    startTimer() {
        this.timerInterval = setInterval(() => {
            if (this.startTime) {
                const elapsed = Date.now() - this.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                this.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }
    
    stopTimer() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.timerInterval = null;
        }
    }
    
    async downloadData() {
        if (this.recordedChunks.length === 0) {
            this.statusText.textContent = 'No recording to download';
            return;
        }
        
        try {
            // Create timestamp for filenames
            const now = new Date();
            const timestamp = now.getFullYear() + '-' + 
                            String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(now.getDate()).padStart(2, '0') + '_' + 
                            String(now.getHours()).padStart(2, '0') + '-' + 
                            String(now.getMinutes()).padStart(2, '0') + '-' + 
                            String(now.getSeconds()).padStart(2, '0');
            
            this.statusText.textContent = 'Preparing downloads...';
            
            // Create video blob
            const videoBlob = new Blob(this.recordedChunks, { type: 'video/webm' });
            
            // Create sensor data JSON
            const sensorDataObj = {
                recordingInfo: {
                    startTime: new Date(this.startTime).toISOString(),
                    duration: Date.now() - this.startTime,
                    sampleCount: this.sensorData.length
                },
                sensorData: this.sensorData
            };
            
            const sensorBlob = new Blob([JSON.stringify(sensorDataObj, null, 2)], { 
                type: 'application/json' 
            });
            
            // For iOS Safari, we need to handle downloads differently
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            
            if (isIOS || isSafari) {
                // iOS Safari approach - open in new tab/window
                this.statusText.textContent = 'Opening files in new tabs (iOS Safari)...';
                
                // Video file
                const videoUrl = URL.createObjectURL(videoBlob);
                const videoWindow = window.open(videoUrl, '_blank');
                if (videoWindow) {
                    videoWindow.document.title = `recording_${timestamp}.webm`;
                }
                
                // Wait a bit
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Sensor data file
                const sensorUrl = URL.createObjectURL(sensorBlob);
                const sensorWindow = window.open(sensorUrl, '_blank');
                if (sensorWindow) {
                    sensorWindow.document.title = `sensor_data_${timestamp}.json`;
                }
                
                this.statusText.textContent = 'Files opened in new tabs. Use "Save As" to download.';
                
                // Clean up URLs after delay
                setTimeout(() => {
                    URL.revokeObjectURL(videoUrl);
                    URL.revokeObjectURL(sensorUrl);
                }, 10000);
                
            } else {
                // Standard download approach for other browsers
                await this.downloadFile(videoBlob, `recording_${timestamp}.webm`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                await this.downloadFile(sensorBlob, `sensor_data_${timestamp}.json`);
                this.statusText.textContent = 'Files downloaded successfully!';
            }
            
        } catch (error) {
            console.error('Error downloading files:', error);
            this.statusText.textContent = 'Error downloading files';
        }
    }
    
    downloadFile(blob, filename) {
        return new Promise((resolve) => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            
            // Force user interaction for iOS
            link.target = '_blank';
            
            // Add to DOM, click, then remove
            document.body.appendChild(link);
            
            // Use both click methods for better compatibility
            if (link.click) {
                link.click();
            } else {
                // Fallback for older browsers
                const event = new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                });
                link.dispatchEvent(event);
            }
            
            document.body.removeChild(link);
            
            // Clean up URL after a delay
            setTimeout(() => {
                URL.revokeObjectURL(url);
                resolve();
            }, 2000);
        });
    }
}

// Initialize the app when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new VideoSensorRecorder();
});

// Handle page visibility changes (important for iOS)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('Page hidden');
    } else {
        console.log('Page visible');
    }
});
  </script>
 </body>
</html>
